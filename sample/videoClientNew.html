<!DOCTYPE html>
<html lang="en" >
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="">
	<meta name="author" content="">
	<title>IBM WebRTC Demo</title>
	<!-- Bootstrap core CSS -->
  <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="resources/css/rtcomm.css" rel="stylesheet">

  <script src="http://code.jquery.com/jquery-2.1.1.js"></script>
  <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

<!-- The following paths may need to be modified depending on the location of this script. -->

  <script src="../lib/mqttws31.js"></script>
  <script src="../dist/rtcomm.js"></script>

	<style type="text/css">
		html {
		  height: 100%;
		}
		body {
			height: 100%;
			width: 100%;
			font-family: HelveticaNeue-Light, Arial, sans-serif;
			padding-top: 60px;
			padding-bottom: 40px;
		}
	</style>
</head>

<body>
	<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Rtcomm HelpDesk Agent</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
           	<li class="active"><a href="index.html">Home</a></li>
          </ul>
        </div>
      </div>
    </div>
 	<div class="container-fluid">
		<div class="row">
			<div class="col-md-2">
        <div class = "panel panel-primary">
          <div class="panel-heading">
>>           <span class="glyphicon glyphicon-comment"></span> Presence
           </div>
           <div id='presenceContainer'></div>
        </div>
			</div>
			<div class="col-md-9">
      <div id="videoContainer">
        <div id='selfViewContainer'>
          <video title="selfView" poster='resources/video_camera.png' id="selfView" class="selfView" autoplay="true" muted="true" ></video>
        </div>
        <video title="remoteView" poster='resources/video_camera_big.png' id="remoteView" class="remoteView" autoplay="true" >
        </video>
      </div>
      <div class="video-controls">
        <div class="btn-group pull-left" style='padding-top:10px'>
         <button id='btnRegister' class='btn btn-primary'>
           Register
          </button>
          <button id='btnConnect' class='btn btn-default' disabled='disabled'>
             Connect  
          </button>
        </div>
        <div id='statusMessage' class="pull-right logo" style="font-size: 24px; padding-right: 30px">
              Please Register
        </div>
      </div>
      </div>
    </div>
  </div>
</div>

<div id="answerDialog" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Answer?</h4>
      </div>
      <div class="modal-body">
       <p> Answer a call</p>
      </div>
      <div class="modal-footer">
        <button id='answerNo' type="button" class="btn btn-default" data-dismiss="modal">No</button>
        <button id='answerYes' type="button" class="btn btn-primary">Yes</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="registerModal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Register</h4>
      </div>
      <div class="modal-body">
        <div id='regAlert' class="alert alert-danger hidden" role="alert" >
        A UserID is required to Register
        </div>
          It is necessary to register before doing anything. The ID used here
          is the ID that another registered user can use to <b>Connect</b>
          <br>
          <br>
          <div>
 
        <div class="input-group">
          <span class="input-group-addon">ID:</span>
          <input id="userid" class="form-control" type="text"  placeholder="userid to register">
        </div>
       </div>
      </div>
      <div class="modal-footer">
        <button id='regCancel' type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button id='regGo' type="button" class="btn btn-primary" data-dismiss="modal" >Go</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="connectModal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Connect</h4>
      </div>
      <div class="modal-body">
      <div id='connAlert' class="alert alert-danger hidden" role="alert" >
        A UserID is required to Connect to
        </div>
         Enter the User ID to connect to.  They must be registered with the same server.
          <br>
          <br>
          <div>
        
        <div class="input-group">
          <span class="input-group-addon">ID:</span>
          <input id="remoteid" class="form-control" type="text"  placeholder="userid to connect to">
        </div>
       </div>
      </div>
      <div class="modal-footer">
        <button id='connectCancel' type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button id='connectGo' type="button" class="btn btn-primary" data-dismiss="modal" >Go</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script>

  /*************************************************
   * Define Globals 
   *************************************************/
  // Define the RtcommEndpointProvider globabl variable
  var ibmep = new rtcomm.EndpointProvider();
  // Change the loglevel - default is 'INFO', possibilities are:
  // 'MESSAGES' --> Just log sent/received messages in console.
  // 'DEBUG' -- > log most everything
  // 'TRACE' --> log everything
  ibmep.setLogLevel('TRACE');
  // In this sample, initializing rtcommEndpoint variable as a GLOBAL
  var rtcommEndpoint = null;
  // UI State
  var registered = false;
  var connected = false;
  var autoAnswer = false;

  /* Define the configuration for the EndpointProvider.  THis is REQUIRED and generally must be changed.
   * It MUST match the rtcomm configuration used on the liberty server.
   *  This config can be passed in on the URL via params as well:
   *
   * Example:  videoClient.html?server=servername&port=1883&rtcommTopicPath=/rtcommcompany/
   */
  var epConfig = {
    server : 'messagesight.demos.ibm.com',
    port : 1883,
    managementTopicName : "management",
    appContext: "videosample",
    rtcommTopicPath: "/rtcomm/",
    createEndpoint : true
  };
  var urlConfig = getUrlParams();
  /* can be passed on URL videoClient.html?regwithoutAV=true */
  var regwithAV = !(urlConfig.regwithoutAV === 'true');
  var regOnload = (urlConfig.regOnload === 'true')? true : false;
  var userid = urlConfig.userid || null;
  autoAnswer = (urlConfig.autoAnswer === true)? true : false;
  console.log('Config passed in via URL:', urlConfig);
  console.log('regwithAV is: ', regwithAV);
  // This uses any params passed on URL to override config.
  updateConfig(epConfig, urlConfig);
  var presence = null;

  /********************************************************************
   *  Rtcomm Functions
   *******************************************************************/

   /* doRegister()
   *
   * This function is the meat of the sample and shows how to
   * init the EndpointProvider using epConfig provided above.  This
   * config is using register/getRtcommEndpoint = true so that 
   * the init returns a rtcommEndpoint object.  
   * 
   *  This can be decoupled and register() and getRtcommEndpoint() can be
   *  called individually.
   * 
   */
  function doRegister(userid) {
    updateMessage('Registering... '+ userid);
    epConfig.userid = userid;
    // make sure this is an integer.
    epConfig.port = parseInt(epConfig.port);
    //  If the EndpointProvider is ready, it has already been init'd, we don't need to init again. Just register again.
    // Call init() on the Endpoint Provider.
    ibmep
          .init(
              epConfig,
              function(object) { //onSuccess
                // Because register/getRtcommEndpoint is enabled, we expect an object
                // returned in the onSuccess callback.
                console.log('init was successful, rtcommEndpoint: ', object);
                updateMessage('Registered');
                uiRegister(userid);
                // Configure the rtcommEndpoint now
                rtcommEndpoint = object.endpoint;
                rtcommEndpoint.webrtc.setLocalMedia(
                  { enable: false, 
                    mediaOut: document.querySelector('#selfView'),
                    mediaIn: document.querySelector('#remoteView'),
                  });
                if (regwithAV) {
                  // Enable Audio Video here.
                  console.log('>>>>>>>>>>>>>>>>>>>Enabling Webrtc...');
                  rtcommEndpoint.webrtc.enable({lazyAV: false}, function() {
                    console.log('>>>>>>>>>>>>>>SUCCESS ENABLED WEBRTC CALLBACK');
                  });
                }
              // getPresenceMonitor
              presence = ibmep.getPresenceMonitor();
              presence.on('updated',updatePeerList);
              presence.add("/");
              }, function(error) { //onFailure
                console.error('init failed: ', error);
                alertMessage('Initialization and registration failed!');
                uiUnregister();
              });
    return true;
  };

    // Assign the callbacks
    // endpointObject.onNewConnection = onNewConnection;
    // This will ask user for access to video and attach it to MediaIn
    // This can be done  when addEndpoint/acceptEndpoint is called but right now,
    // the video/video is more reliable if it is attached before a call is created.

  ibmep.setRtcommEndpointConfig({
      broadcast: {audio: true, video: true},

      'webrtc:connected': function(event_object) {
        uiConnect("Connected to "+event_object.endpoint.getRemoteEndpointID());
      },

      'webrtc:disconnected': function(event_object) {
          
          document.querySelector('#remoteView').src = undefined;
          uiDisconnect("Disconnected from "+ event_object.endpoint.getRemoteEndpointID());
        try {
          event_object.endpoint.disconnect();
           } catch (e) {
          console.error(e);
        }
      },
      'session:ringing': function(event_object) {
      if (event_object.object && event_object.object.pcSigState) {
        if (event_object.object.pcSigState === 'have-local-offer') {
          // we are the CALLER.
          // This could be tracked through the UI too.
          updateMessage('Calling ' + event_object.object.remoteID);
        } else {
          updateMessage('Inbound call from  ' + event_object.endpoint.getRemoteEndpointID());
        }
      }
      },
      'session:alerting': function(event_object) {
        console.log('>>>> event_object! ', event_object);
        // Use this as a global
        if (!autoAnswer) {
          $('#answerDialog .modal-body').html(
              "Inbound call from " + event_object.endpoint.getRemoteEndpointID());
          $('#answerDialog').modal('show');
        } else {
          status = 'Automatically Answering...';
          event_object.endpoint.accept();
        }
      },
      'session:failed': function(event_object) {
        updateMessage("Connection failed - reason: "+event_object.reason);
      },
      'session:refer': function(event_object) {
        $('#answerDialog .modal-body').html(
            "[3PCC] Initiate call to "+ event_object.endpoint.getRemoteEndpointID());
        $('#answerDialog').modal('show');
      }
  });

  /*****************************************************************
   * UI Related functionality
   ****************************************************************/ 

  // Display the configuration we are using in the UI
  //  displayConfig();


  function uiReset() {
    // unused...
      $('#btnConnect').prop('disabled', 'disabled');
      $('#btnRegister').prop('disabled', false);
      $('#cancel').prop('disabled', false);
      $('#btnRegister').button('reset');
  }

  function uiConnect(message) {
      $('#btnConnect').text('Disconnect');
      updateMessage(message || 'Unknown');
      connected = true;
  };

  function uiDisconnect(message) {
      $('#btnConnect').text('Connect');
      updateMessage(message || 'Unknown');
      connected = false;
  };

  function uiRegister(id) {
    var userid = id || 'unknown';
    $('#displayNameStr').html('Welcome, <span class="blue">' + userid + '</span>');
    updateMessage('Registered');
    $('#btnConnect').prop('disabled', false);
    $('#btnRegister').text('Unregister');
    registered = true;
  };

  function uiUnregister() {
    $('#displayNameStr').html('Please Register');
    updateMessage('Unregistered');
    $('#btnConnect').prop('disabled', true);
    $('#btnRegister').text('Register');
    registered = false;
  }

  function updateMessage(message) {
    console.log('updateMessage --> '+message);
    $('#statusMessage').html(message);
  }

  $('#answerYes').on('click', function() {
    $("#answerDialog").modal("hide");
    rtcommEndpoint.accept();
  });

  $('#answerNo').on('click', function() {
    $("#answerDialog").modal("hide");
    state='disconnected';
    rtcommEndpoint.reject();
  });

  $('#btnReset').on('click', function() {
    rtcommEndpoint && rtcommEndpoint.reset();
    rtcommEndpoint = null;
    ibmep && ibmep.destroy();
    ibmep = null;
    updateMessage('Please Register');
    $('#btnRegister').hasClass('active') && $('#btnRegister').button('toggle');

  });

  $('#btnRegister').on('click', function() {
    if (registered) {
      ibmep.destroy();
      uiUnregister();
    } else {
      updateMessage('Registering');
      $('#registerModal').modal('show');
    }
  });

  $('#regGo').on('click', function() {
    var userid = $("#userid").val();
    // Make sure userid is set.
    if (userid === "") {
      $('#regAlert').show();
      return false;
    } else {
      doRegister(userid);
      $('#regAlert').hide();
    }
  });

  $('#btnConnect').on('click', function() {
    console.log('CONNECT BUTTON: connected: '+connected, rtcommEndpoint);
    if (connected) {
      rtcommEndpoint.disconnect();
      uiDisconnect("Disconnected");
    } else {
      $('#connectModal').modal('show');
    }
  });

  $('#btnToggleBroadcast').on('click', function() {
    if (connected) {
      rtcommEndpoint.webrtc.pauseBroadcast();
    } 
  });

  $("#connectGo").on('click', function(event) {
    var remoteid = $("#remoteid").val();
    // $("#connectModal").modal("hide");
    if (remoteid === "") {
      $('#connAlert').show();
      return false;
    } else {
      /* $("#welcome").html("Welcome, <strong>"+name+"</strong>!");
      $("#displayNameStr").html("Welcome, <span class='blue'>"+name+"</span>");
      lobby.displayName = name;
      lobby.connect();
      initRecorder(); */
      updateMessage('Connecting to '+remoteid);
      // This is only necessary if you want to enable/connect in same motion. 
      rtcommEndpoint.webrtc.enable(function(success, message) {
        console.log('Enable Completed: '+ success);
        if (success) {
          rtcommEndpoint.connect(remoteid);
        } else {
          console.error('enable failed: '+ message)
          }
        });
      $("#connectModal").modal("hide");
      $('#connAlert').hide();
    }
    return false;
  });

  function alertMessage(message) {
    console.log('Updating statusMessge with ', message);
    $('#statusMessage').css('color:red');
    $('#statusMessage').html(message);
    //$('#alertMessage').show();
  }

  function updateConfig(obj1, obj2) {
    // Copy anything in obj2 into obje1 if in obj1
    for (key in obj1) {
      if (obj1.hasOwnProperty(key)) {
        if (obj2.hasOwnProperty(key)) {
          obj1[key] = obj2[key];
        }
      }
    }
  }

  function displayConfig() {
    var configHTML = "";
    for (key in epConfig) {
      if (epConfig.hasOwnProperty(key)) {
        configHTML = configHTML + keyPairToHtml(key, epConfig[key]);
      }
    }
    // console.log('trying to display '+configHTML);
    $('#config').html(configHTML);
  }

  function keyPairToHtml(key, value) {
    var template = '<b>label</b>:value<br>';
    var str = template.replace(/label/i, key);
    return str.replace(/value/i, value);

  }

  function getUrlParams() {
    var url = decodeURIComponent(document.URL);
    var params = [];
    if (url.indexOf('?') > 0) {
      params = url.slice(url.indexOf('?') + 1).split('&');
    }
    // param to hash...
    var paramhash = {};
    params.forEach(function(param) {
      var kv = param.split('=');
      paramhash[kv[0]] = kv[1];
    })
    console.log(paramhash);
    return paramhash;
  }

  function updatePeerList() {
      $('#presenceContainer').empty();
      var buttonTemplate = '<button type="button" id="BTNID" class="btn BTNSTATE btn-lg btn-block presenceItem" data-toggle="tooltip" data-placement="top" title="BTNDESC" >BTNNAME</button>';
      presence.getPresenceData()[0].flatten().forEach(function(item) {
        console.log(item.name);
        var button = buttonTemplate.replace('BTNID', item.presenceTopic).replace('BTNNAME', item.name).replace('BTNDESC', item.alias || "None"); 
         button = button.replace('BTNSTATE','btn-default');
          $(button).appendTo('#presenceContainer');
          // Init the tooltip on the queue
          $('#'+item.name).tooltip();
       });

        $(".presenceItem").on('click', function() {
          var t = $(this).attr('id');
          console.log('Looking up node for t: '+t);
          var node = presence.getPresenceData()[0].getSubNode(t);
          console.log('Node for t: ',node);
          var remoteid = node.name;
          updateMessage('Connecting to '+remoteid);
        // This is only necessary if you want to enable/connect in same motion. 
          rtcommEndpoint.webrtc.enable(function(success, message) {
            console.log('Enable Completed: '+ success);
            if (success) {
              rtcommEndpoint.connect({remoteEndpointID: remoteid, toTopic: node.addressTopic});
            } else {
              console.error('enable failed: '+ message)
            }
          });

        });
  };

window.onload = function() {
  console.log('ONLOAD! '+regOnload+' userid: '+userid);
  if (regOnload && userid) {
    console.log('Calling doRegister!');
    doRegister(userid);
  }
}
</script>
</body>
</html>
