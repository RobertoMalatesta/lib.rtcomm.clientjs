#Rtcomm Signalling Protocol Specification: v0.2.0 


## Abstract
This specification defines version v0.2.0 of the Rtcomm signaling protocol . All Rtcomm protocols are JSON based and built on top of MQTT. The protocol can be broken down into the following two parts:

1. Signaling protocol for connecting WebRTC endpoints into media sessions.
2. Service protocol for things like third party call control and event monitoring.    See [**rtcomm.service.proto.spec.md**](https://github.com/WASdev/lib.rtcomm.node/blob/master/rtcomm.service.proto.spec.md) for details

This specification describes the signaling protocol that occurs between Rtcomm endpoints and Rtcomm connectors (which connect Rtcomm endpoints together). Examples of Rtcomm endpoints include:
- Clients endpoints
- multiway endpoints
- record/playback endpoints.
- basically any endpoint that terminates a signaling session.

This protocol supports all of the following capabilities:

1. Registration of Rtcomm endpoints with an Rtcomm service.
2. Service function queries (event monitoring topic name, ICE configuration,...).
3. Call signaling (WebRTC clients, media resources, gateways,...).
    
# Rtcomm Protocol Definition

This protocol specification relies on the publish/subscribe semantics of the MQTT protocol for a transport. The Rtcomm endpoints and services normally subscribe to one or more topics at a Messaging Broker.    The endpoint communicates with the service by publishing messages to the service's topic name.    Services communicates with a particular endpoint by publishing messages to the endpoint's topic name.

### Endpoint ID Definiton
In the message definitions below, there are many references to various EndpointIDs.  This can be any string that does not include a "/" which represents the Rtcomm endpoint. Its a fundamental building block in the Rtcomm protocol and relates directly to the credentials used to connect to the MQTT message broker. It can be a simple name (i.e. "Danko Jones") or it can be preceded by a protocol descriptor (i.e. "sip:dankojones@xyz.com").

### Identity Propogation
When an Rtcomm message is sent to a remote topic, the sender publishes to a topic name that is a combination of the remote topic name being subscribed on by the receiver + the senders endpoint ID. For example, if the topic name subscribed on by the receiver is "/rtcomm/connector", the sender publishes to "/rtcomm/connector/"sender's endpoint ID".  This is done in order to propagate endpoint IDs in a secure manner. 
MQTT message brokers can be securely configured to only allow endpoints with proper credentials to publish to MQTT topics that include an appended endpoint ID. Endpoint IDs are sent in this manner to insure the ID is not spoofed. Because of this you never see the senders endpoint ID includes in an Rtcomm message definition.

### PeerContent Definition
As you'll see in the various signaling messages below, some messages contain a header key named "peerContent" which contains a JSON object that includes a type and some data content as follows: 

| Key                   | Value                                     |
| ----------------------|:-------------------------------------------|
| peerContent           | JSON object defined in the table below. |


This JSON object that represents the peerContent value contains at most a single "type" key/value pair and a data type key followed by the associated data like this:

| Key                   | Value                                     |
| ----------------------|:-------------------------------------------|
| type                | e.g. "offer", "answer", "pranswer", "icecandidate", "user", "refer" |
| One of the following data types:"sdp", "candidate", "userData", "details") | see table below for details |

Rtcomm currently supports the following peer content data types (only one of these can exist within a peerContent JSON object at a time):

| Key                   | Value                                     |
| ----------------------|:-------------------------------------------|
| sdp                 | raw data (based on standards) |
| candidate           | raw data (based on standards) |
| userData           | user defined JSON object  |
| details             | JSON object associated with an rtcomm refer (see below) |

Note:  Two of the peerContent data types (sdp and candidate) are generated by the WebRTC API and are typically associated with the following peerContent type(s): offer, answer, pranswer, and icecandidate. See these links for details:

http://dev.w3.org/2011/webrtc/editor/webrtc.html#session-description-model.   
http://tools.ietf.org/id/draft-nandakumar-rtcweb-sdp-01.html.  

The "user" and "refer" type(s) were defined as part of the Rtcomm protocol specification. The "refer" JSON object is defined below:

| Key                   | Value                                     |
| ----------------------|:-------------------------------------------|
| sessionID             | Globally unique ID associated with the session to be created by the refer |
| toEndpointID          | The toEndpoint ID of the endpoint to call |
| appContext            | The application context to associate the refer to. More on this below.|




## Endpoint Registration

In order for a service to locate an endpoint, it needs to know the endpoint's identifier and the corresponding topic that the endpoint is subscribed to.    When an endpoint registers with an Rtcomm service of some type, it supplies its identifier and topic name.    The service stores this registration information.    The service stores this registration temporarily and the endpoint needs to re-register periodically to maintain the registration.    The REGISTER response contains an "expires" header which lets the endpoint know how often to re-register.

Here is an example of a REGISTER message sent to the service:

| Key                   | Value                                     |
| ----------------------|:-------------------------------------------|
| method                | REGISTER |
| rtcommVer             | e.g.  v0.2.0          |
| transID               | transaction ID, this is a unique identifier associated with this transaction.   e.g.  ca80371e-0b42-49a2-ad32-c88711f573e7 |
| fromTopic             | Source endpoint topic where the response should be published to.   e.g.  /rtcomm/2123928217 |
| regTopic              | topic that the endpoint is subscribed to. Typically the same as the from topic.   e.g.  /rtcomm/2123928217 |
| appContext            | application context associated with the registration   e.g. "XYZ video app"|

Note:    appContext is used at the endpoint to associate an inbound START_SESSION with the appropriate application in cases where multiple applications could be running.    There can only be one registered topic name associated with a single endpointID/appContext.

The service will respond by publishing the following message to the "fromTopic" listed in the REGISTER request,  "/rtcomm/2123928217".

Here is an example of a REGISTER response:

| Key                   | Value                                     |
| ----------------------|:-------------------------------------------|
| method                | RESPONSE |
| orig                  | Original method that caused the response: e.g. REGISTER |
| rtcommVer             | e.g.  v0.2.0          |
| expires               | number of seconds before the registration entry expires. e.g.  120          |
| transID               | transaction ID, this is a unique identifier associated with this transaction.   e.g.  ca80371e-0b42-49a2-ad32-c88711f573e7 |
| result    	        | result of the operation    e.g.  SUCCESS or FAILURE |
| reason				| Optionally included if FAILURE is the result. String explaining why the request failed |

Here is an example of a UNREGISTER message sent to the service:

| Key                   | Value                                     |
| ----------------------|:-------------------------------------------|
| method                | UNREGISTER |
| rtcommVer             | e.g.  v0.2.0          |
| regTopic              | topic that the endpoint is subscribed to. e.g.  /rtcomm/2123928217 |
| appContext            | application context associated with the registration   e.g. "XYZ video app"|

## Service query

An endpoint can make a service query to discover what services are provided.  A service query returns information related to the service including things like ICE servers the client endpoint should use, service topic names, etc. As other services are added, they will be advertised in this query.

Here is an example of a SERVICE_QUERY message sent to the service:

| Key                   | Value                                     |
| ----------------------|:-------------------------------------------|
| method                | SERVICE_QUERY |
| rtcommVer             | e.g.  v0.2.0         |
| transID               | transaction ID, this is a unique identifier associated with this transaction.   e.g.  b2a4247f-fafc-4d3c-a23b-822d02e8f08b |
| fromTopic             | topic where the response must be published to.   e.g.  /rtcomm/2123928217 |
<br/>

Here is an example of a SERVICE_QUERY response:

| Key                   | Value                                     |
| ----------------------|:-------------------------------------------|
| method                | RESPONSE |
| orig                  | SERVICE_QUERY |
| rtcommVer             | e.g.  v0.2.0          |
| transID               | transaction ID, this is a unique identifier associed with this transaction.   e.g.  b2a4247f-fafc-4d3c-a23b-822d02e8f08b |
| services    	        | JSON object containing services available    e.g.  eg. {"iceURL":"stun:stun.juberti.com:3478,turn:test@stun.juberti.com:3478:credential:test","eventMonitoringTopic":"/rtcomm/event"} |
| result    	        | result of the operation    e.g.  SUCCESS or FAILURE |
| reason				| Optionally included if FAILURE is the result. String explaining why the request failed |

The "services" header listed above is a JSON object.     

## Signaling for peer to peer sessions

An endpoint uses a signaling session to setup real-time media streams with another endpoint.  Setting up this session requires a number of message exchanges.   The call signaling protocol can be used for client to service communications, or directly between 2 endpoints (assuming the endpoints have permission to publish on their counterparts topic name).   

This is the first message sent from the endpoint to start a new signaling session:

| Key                   | Value                                     |
| ----------------------|:-------------------------------------------|
| method                | START_SESSION |
| rtcommVer             | e.g.  v0.2.0          |
| transID               | transaction ID, this is a unique identifier associated with this transaction.   e.g.  a57ffe3f-d964-4818-b32a-053c1303a1bb |
| fromTopic             | topic where the response must be published to.   e.g.  /rtcomm/2018097881 |
| toEndpointID          | callee endpoint ID.   e.g. johnDoe |
| appContext            | application context associated with the application (optional)   e.g. "XYZ video app"|
| sigSessID             | Globally unique ID associated with this session   e.g. 553eebdc-6884-47e4-a656-fd89a920bb68 |
| peerContent           | Typically includes the SDP offer for this session.    e.g. {"type":"offer","sdp":...}|

Note:    sigSessID should be a UUID to insure it is globally unique.


If this message is sent to a Rtcomm connector service, the service looks up the toEndpointID in the registry, and forwards it to the destination endpoint.


In response to the START_SESSION message, the callee responds may respond with an optional PRANSWER:

| Key                   | Value                                     |
| ----------------------|:-------------------------------------------|
| method                | PRANSWER |
| rtcommVer             | e.g.  v0.2.0         |
| transID               | transaction ID, this is a unique identifier associated with this transaction.   e.g.  a57ffe3f-d964-4818-b32a-053c1303a1bb |
| fromTopic             | Client topic where subsequent messages related to this session should be published.   e.g.  /rtcomm/2123928217 |
| sigSessID             | unique ID associated with this session.   e.g. 7246298a-4b2c-477b-b6cf-410e37074063 |
| peerContent           | May include SDP information or ICE candidates.  e.g. {"type":"pranswer"} |
| holdTimeout           | May include hold timeout value (in seconds).   This tells the call originator how long to wait for the call to be established. |
| queuePosition           | May include queue position.   This tells the call originator where the call stands in the queue.    If this is 0, the call is actively being connected.


The caller and/or callee endpoint(s) may also send out another message which specifies one or more ICE candidates:

| Key                   | Value                                     |
| ----------------------|:-------------------------------------------|
| method                | MESSAGE |
| rtcommVer             | e.g.  v0.2.0          |
| transID               | transaction ID, this is a unique identifier associated with this transaction.   e.g.  a57ffe3f-d964-4818-b32a-053c1303a1bb |
| fromTopic             | Client topic where subsequent messages related to this session should be published.   e.g.  /rtcomm/2123928217 |
| sigSessID             | unique ID associated with this session.  e.g. 7246298a-4b2c-477b-b6cf-410e37074063 |
| peerContent           | includes SDP information about the session.   e.g. {"type":"icecandidate","candidate":{"sdpMLineIndex":0,"sdpMid":"audio","candidate":"a=candidate:3013953624 1 udp 2122260223 192.168.1.100 56617 typ host generation 0\r\n"}} |

The callee endpoint will eventually respond to the START_SESSION:

| Key                   | Value                                     |
| ----------------------|:-------------------------------------------|
| method                | RESPONSE |
| orig                  | Method type that started the transaction. In this case: START_SESSION |
| rtcommVer             | e.g.  v0.2.0          |
| transID               | transaction ID, this is a unique identifier associated with this transaction.   e.g.  a57ffe3f-d964-4818-b32a-053c1303a1bb |
| fromTopic             | Client topic where subsequent messages related to this session should be published.   e.g.  /rtcomm/116396706 |
| sigSessID             | unique ID associated with this session.   e.g. 7246298a-4b2c-477b-b6cf-410e37074063 |
| peerContent           | includes SDP information about the session.    e.g. {"type":"answer",...} |
| result                | result of operation    e.g. SUCCESS or FAILURE |
| reason				| Optionally included if FAILURE is the result. String explaining why the request failed |

Either the caller or callee can send an in session message at any time. This message could be used to send opaque user data or to simply update a session description.

| Key                   | Value                                     |
| ----------------------|:-------------------------------------------|
| method                | MESSAGE |
| rtcommVer             | e.g.  v0.2.0          |
| transID               | transaction ID, this is a unique identifier associated with this transaction.   e.g.  a57ffe3f-d964-4818-b32a-053c1303a1bb |
| fromTopic             | Client topic where subsequent messages related to this session should be published.   e.g.  /rtcomm/116396706 |
| sigSessID             | unique ID associated with this session.   e.g. 7246298a-4b2c-477b-b6cf-410e37074063 |
| peerContent           | Content associated with the message.    e.g. {"type":"answer",...} |


At the end of the session, one of the endpoints will termiante the session by sending this message to the remote endpoint:

| Key                   | Value                                     |
| ----------------------|:-------------------------------------------|
| method                | STOP_SESSION |
| rtcommVer             | e.g.  v0.2.0          |
| transID               | transaction ID, this is a unique identifier associated with this transaction.   e.g.  a57ffe3f-d964-4818-b32a-053c1303a1bb |
| sigSessID             | unique ID associated with this session.  e.g. 553eebdc-6884-47e4-a656-fd89a920bb68 |
| reason 				| Reason session is ending.  e.g. session terminated by endpoint |


Note: no response is sent after a stop session.


## Call referral

The protocol supports call referral. A "call referral" is used to make a request to an endpoint to establish a call with another endpoint. This method of initiating a signaling session is usually triggered through third party call control.

This following defines a refer message.    

| Key                   | Value                                     |
| ----------------------|:-------------------------------------------|
| method                | START_SESSION |
| rtcommVer             | e.g.  v0.2.0        |
| transID               | transaction ID, this is a unique identifier associated with this transaction.   e.g.  b2a4247f-fafc-4d3c-a23b-822d02e8f08b |
| fromTopic             | topic where the response must be published to.   e.g.  /rtcomm/116396706 |
| toEndpointID          | callee endpoint ID   e.g. Danko Jones |
| sigSessID             | unique ID associated with this session.    e.g. bf222ce6-00a4-4890-8dba-324bb52533ea |
| appContext            | application context associated with the application (optional)   e.g. "XYZ video app"|
| peerContent           | details about the refer operation.    e.g. :{"details":{"sessionID":"1234567888","toEndpointID":"johnDoe"},"type":"refer"}|

This following is the response to the refer:

| Key                   | Value                                     |
| ----------------------|:-------------------------------------------|
| method                | RESPONSE |
| orig                  | START_SESSION |
| rtcommVer             | e.g.  v0.2.0          |
| transID               | transaction ID, this is a unique identifier associated with this transaction.   e.g.  b2a4247f-fafc-4d3c-a23b-822d02e8f08b |
| fromTopic             | topic where the response must be published to.   e.g.  /rtcomm/2018097881 |
| toEndpointID          | caller endpoint ID    e.g. Danko Jones |
| sigSessID             | unique ID associated with this session.    e.g. bf222ce6-00a4-4890-8dba-324bb52533ea |
| result                | result of the operation    e.g. SUCCESS or FAILURE |
| reason				| Optionally included if FAILURE is the result. String explaining why the request failed |

After a successful refer, the session remains active until the STOP_SESSION is sent. This could eventually allow status information about the call to be send via the refer session. 

## Last Will and Testament Message

This message is actually an empty message.    There is NO data in this message.    The server uses this message as notification that the endpoint is no longer available.    The fromEndpointID is parsed from the end of the topic name.    All registrations that use this ID, and all sessions established with this ID are canceled.
